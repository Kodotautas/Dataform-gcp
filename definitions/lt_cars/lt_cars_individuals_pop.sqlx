config { 
        type: "view",
        description: 'SQL to get top individual cars by municipality'
       }

WITH base AS (
  SELECT
    SAVIVALDYBE,
    concat(MARKE,' ', KOMERCINIS_PAV) as make_model,
    GALIA,
    RIDA
  FROM `vl-data-learn.lithuania_statistics.Atviri_TP_parko_duomenys`
  WHERE SAVIVALDYBE NOT LIKE '%BALTARUSIJA%' 
      AND SAVIVALDYBE NOT LIKE '%JUNGTINĖ KARALYSTĖ%'
      AND SAVIVALDYBE NOT LIKE '%KANADA%'
      AND SAVIVALDYBE NOT LIKE '%LATVIJA%'
      AND (GALIA < 1000 OR GALIA IS NULL)
),
make_model_counts AS (
  SELECT
    SAVIVALDYBE,
    make_model,
    COUNT(*) AS model_count,
    AVG(RIDA) as avg_mileage,
    ROW_NUMBER() OVER(PARTITION BY SAVIVALDYBE ORDER BY COUNT(*) DESC) AS row_num
  FROM base
  WHERE make_model != 'Nuasmeninta Nuasmeninta'
  GROUP BY SAVIVALDYBE, make_model
)

SELECT
  SAVIVALDYBE,
  make_model,
  model_count,
  ROUND(avg_mileage,0) as avg_mileage
FROM make_model_counts
WHERE row_num <= 100 AND avg_mileage IS NOT NULL
ORDER BY SAVIVALDYBE, model_count DESC